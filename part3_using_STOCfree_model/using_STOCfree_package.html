<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Using the STOCfree package</title>
    <meta charset="utf-8" />
    <meta name="author" content="Aurélien Madouasse" />
    <meta name="date" content="2020-11-11" />
    <script src="libs/header-attrs-2.3/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link rel="stylesheet" href="extra.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Using the STOCfree package
### Aurélien Madouasse
### UMR BIOEPAR, Oniris, INRAE
### 11/11/2020

---





# Aims of the session

- At the end of the session, participants should:
 - Be able to use the `STOCfree` package to predict herd level probabilities of infection
 - Understand the basics of how estimation and prediction are performed
 - Understand and explore model outputs

 
- Feedback we would like from the participants:
 - Suitability of the model for longitudinal surveillance data
 - Features that are missing or that need improvement
 - Any suggestion that could help making the package more useful
 

---
# Programme of the session

1. Introduction to the `STOCfree` package

1. Modelling of herd level data using test results only

1. Modelling of herd level data using test results and a risk factor

1. Modelling of animal level data

---
class: inverse, center, middle

# The STOCfree package

---
# The STOCfree package

- `R` + `JAGS` implementation of the STOC free model

- set of functions to build, run and analyse the output gathered in an `R` package

- package hosted and documented on Github

.center[https://github.com/AurMad/STOCfree]

---
![](./imgs/STOCfree_Github.png)
---
# The STOCfree package

- package description and tutorial at the bottom of the page (README)

- R folder: R scripts defining the functions provided in the package

 - `write_JAGS_model.R`: JAGS models

 - `STOCfree_data.R`: building of STOCfree_data objects

---
# STOCfree package dependencies

- `JAGS` version 4.3: estimation of model parameters and prediction

.center[https://sourceforge.net/projects/mcmc-jags/files/]

- R packages

 - `rjags`: interfaces R with JAGS
 - `coda`: processes JAGS output
 - `dplyr`, `tibble`: data manipulation in R
 - `tidybayes`: processing of JAGS output using the tidy syntax

---
# Installing the STOCfree package from Github

- The STOCfree package needs to be installed from Github using the `install_github()` function from the `devtools` package


```r
## attaching the devtools package
library(devtools)

## installing the package
install_github("AurMad/STOCfree")
```

---
# Setting up the R session

- The different packages we will use
 - STOCfree
 - tidyverse
 - ggplot2


```r
library(STOCfree)
library(tidyverse)
library(ggplot2)
```

---
class: inverse, center, middle

# Modelling herd level data
# Test results only

---
# The herdBTM dataset

- Included in the `STOCfree` package as an example of herd level data
- Represents herd level bulk tank milk BVDV antibody testing
- Data collected approximately every 6 months in every herd


```r
head(herdBTM)
```

```
## # A tibble: 6 x 6
##   Farm  DateOfTest   ODR Test    TestResult LocalSeroPrev
##   &lt;chr&gt; &lt;date&gt;     &lt;dbl&gt; &lt;chr&gt;        &lt;dbl&gt;         &lt;dbl&gt;
## 1 FR001 2014-02-04  57.6 BTM_ODR          1          0.12
## 2 FR001 2014-03-01  NA   confirm          1          0.12
## 3 FR001 2014-09-10  66.5 BTM_ODR          1          0.1 
## 4 FR001 2014-10-01  NA   confirm          1          0.1 
## 5 FR001 2015-02-01  52.5 BTM_ODR          1          0.08
## 6 FR001 2015-03-01  NA   confirm          1          0.08
```

---
# The herdBTM dataset

- The different columns are:
 - **`Farm`**: farm ID
 - **`DateOfTest`**: date of test
 - **`ODR`**: test result as a continuous value (optical density ratio)
 - **`Test`**: test used. Either `BTM_ODR` for optical density ratio on bulk tank milk, or `confirm` for confirmatory testing
 - **`TestResult`**: ODR value categorised as negative (ODR &lt; 35) or positive (ODR `\(\geq\)` 35)
 - **`LocalSeroPrev`**: local seroprevalence, i.e. prevalence of test positive in the neighbourhood

---
# The herdBTM dataset

- We will only use results from `BTM_ODR` tests and store the resulting object in a variable called `bvd`


```r
bvd &lt;- herdBTM %&gt;%
  filter(Test == 'BTM_ODR') %&gt;%
  select(Farm, DateOfTest, ODR, TestResult, LocalSeroPrev)
```

---
# Steps of the analysis

1. Build a `STOCfree_data` object from surveillance data

1. Define prior distributions for test characteristics

1. Define prior distributions for status dynamics

1. Compile the model

1. Sample from the model

1. Process and analyse model output

---
# Building a STOCfree_data object

- Type `?STOCfree_data` to see the function's help page

- We will first run the model using test results only

- Using the `bvd` dataset:


```r
sfd &lt;- STOCfree_data(
  test_data = bvd,
  test_herd_col = "Farm",
  test_date_col = "DateOfTest",
  test_res_col = "TestResult",
  test_level = "herd")
```

---
# STOCfree_data objects' structure


```r
str(sfd, max.level = 1)
```

```
## List of 8
##  $ var_names       : Named chr [1:3] "Farm" "DateOfTest" "TestResult"
##   ..- attr(*, "names")= chr [1:3] "test_herd_col" "test_date_col" "test_res_col"
##  $ herd_id_corresp :'data.frame':	100 obs. of  2 variables:
##  $ test_data       :'data.frame':	680 obs. of  6 variables:
##  $ herd_test_data  :'data.frame':	100 obs. of  3 variables:
##  $ test_perf_prior :'data.frame':	1 obs. of  6 variables:
##  $ risk_factors    :'data.frame':	1 obs. of  3 variables:
##  $ risk_factor_data:'data.frame':	3300 obs. of  4 variables:
##  $ inf_dyn_priors  : Named logi [1:6] NA NA NA NA NA NA
##   ..- attr(*, "names")= chr [1:6] "pi1_a" "pi1_b" "tau1_a" "tau1_b" ...
##  - attr(*, "level")= chr "herd"
##  - attr(*, "number of herds")= int 100
##  - attr(*, "number of tests")= num 1
##  - attr(*, "month first test")= chr "2014-02"
##  - attr(*, "month last test")= chr "2016-10"
##  - attr(*, "number of risk factors")= num 0
##  - attr(*, "class")= chr [1:2] "herd" "STOCfree_data"
```

---
# STOCfree_data objects' structure

- Column names correspondence between STOCfree_data objects and original dataset


```r
sfd$var_names
```

```
## test_herd_col test_date_col  test_res_col 
##        "Farm"  "DateOfTest"  "TestResult"
```

---
# STOCfree_data objects' structure

- Herds numbered from 1 to number of herds

- Correspondence between original herd id and herd id used by the model stored in the `STOCfree_data` object


```r
sfd$herd_id_corresp
```


```
##     Farm herd_id
## 1  FR001       1
## 2  FR002       2
## 3  FR003       3
## 4  FR004       4
## 5  FR005       5
## 6  FR006       6
## 7  FR007       7
## 8  FR008       8
## 9  FR009       9
## 10 FR010      10
```

---
# STOCfree_data objects' structure

- Test data:


```r
sfd$herd_test_data
```


```
##    status_id herd_id month_id status_type test_id test_res
## 1          1       1        1           1       1        1
## 2          8       1        8           2       1        1
## 3         13       1       13           2       1        1
## 4         20       1       20           2       1        1
## 5         25       1       25           2       1        1
## 6         32       1       32           2       1        0
## 7         33       1       33           4      NA       NA
## 8         34       2        1           1       1        0
## 9         41       2        8           2       1        0
## 10        46       2       13           2       1        0
```

 - Can you guess what the different columns correspond to?

---
# STOCfree_data objects' structure

- Check the original data:


```r
## for herd_id i, Farm is
i &lt;- 1
herd_id_i &lt;- sfd$herd_id_corresp$Farm[sfd$herd_id_corresp$herd_id == i]

## extracting herd data
bvd %&gt;%
  filter(Farm == herd_id_i) %&gt;%
  View()
```

---
# STOCfree_data objects' structure

- herd_test_data
 - Contains index (`status_id`) of first and last test for each month


```r
sfd$herd_test_data
```


```
##    herd_id ind_i ind_p
## 1        1     1    33
## 2        2    34    66
## 3        3    67    99
## 4        4   100   132
## 5        5   133   165
## 6        6   166   198
## 7        7   199   231
## 8        8   232   264
## 9        9   265   297
## 10      10   298   330
```

---
# STOCfree_data objects' structure

- Prior distributions for test characteristics
 - Beta distributions
 - Need to specify `\(\alpha\)` and `\(\beta\)` parameters for sensitivity and specificity


```r
sfd$test_perf_prior
```

```
##         test test_id Se_a Se_b Sp_a Sp_b
## 1 TestResult       1   NA   NA   NA   NA
```

- Here, 1 row because only 1 test present in the dataset

- What would be good priors for our test?

---
# Visualising Beta distributions

- `betadistapp` package
 - shiny app
 - displays `\(\alpha\)` and `\(\beta\)` for Beta distributions plotted using sliding scales for mean and sd
 - plots Beta distributions using `\(\alpha\)` and `\(\beta\)` as inputs

- install the package

```r
devtools::install_github("AurMad/betadistapp")
```

- run the app


```r
betadistapp::shiny_beta()
```

---
# Prior distributions for test characteristics

- Prior distributions specified using the `set_priors_tests()` function


```r
sfd &lt;- set_priors_tests(sfd,
                 Se_a = 5000,
                 Se_b = 260,
                 Sp_a = 9000,
                 Sp_b = 1000)
```

---
# Prior distributions for test characteristics

- Check that the `STOCfree_data` object has been updated


```r
show_tests(sfd)
```

```
##         test test_id Se_a Se_b Sp_a Sp_b
## 1 TestResult       1 5000  260   20    2
```

---
# Prior distributions for test characteristics

- Plot the prior distributions for test characteristics


```r
plot_priors_tests(sfd)
```

![](using_STOCfree_package_files/figure-html/plot test characteristics-1.png)&lt;!-- --&gt;

---
# Prior distributions for infection dynamics

- We need prior Beta distributions for:
 - probability of infection on the first test ( `\(\pi_1\)` )
 - probability of new infection between consecutive months ( `\(\tau_1\)` )
 - probability of not eliminating the infection between consecutive months ( `\(\tau_2\)` )


```r
sfd$inf_dyn_priors
```

```
##  pi1_a  pi1_b tau1_a tau1_b tau2_a tau2_b 
##     NA     NA     NA     NA     NA     NA
```

---
# Prior distributions for infection dynamics

- Prior distributions are set using the `set_priors_inf_dyn`


```r
sfd &lt;- set_priors_inf_dyn(sfd,
                   pi1_a = 1,
                   pi1_b = 1,
                   tau1_a = 1.5,
                   tau1_b = 10,
                   tau2_a = 10,
                   tau2_b = 1.5)
```

---
# Prior distributions for infection dynamics

- Parameters of the prior distributions can be checked with the `show_inf_dyn()` function


```r
show_inf_dyn(sfd)
```

```
##  pi1_a  pi1_b tau1_a tau1_b tau2_a tau2_b 
##    1.0    1.0    1.5   10.0   10.0    1.5
```

---
# Prior distributions for infection dynamics

- Prior distributions are plotted with the `plot_priors_inf_dyn()` function


```r
plot_priors_inf_dyn(sfd)
```

![](using_STOCfree_package_files/figure-html/plot infection dynamics priors-1.png)&lt;!-- --&gt;

---
# Model compilation

- Using the `compile_JAGS()` function:


```r
compiled_model &lt;- compile_JAGS(sfd,
                               n_chains = 4,
                               keep_model_file = TRUE)
```

```
## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 580
##    Unobserved stochastic nodes: 3404
##    Total graph size: 22636
## 
## Initializing model
```

---
# Model compilation

- The function sends our model, data and priors to JAGS

- The model corresponding to our specifications is written into a text file that will be used by JAGS:
 - herd level
 - no risk factor
 - stored in a file called `JAGS_model.txt` in your working directory (because we used the argument `keep_model_file = TRUE`)

---
# Model sampling

- The aims are to obtain:
 - samples from the posterior distributions of the model parameters
 - distributions of predicted probabilities of infection for each herd in the data


```r
samples &lt;- sample_model(compiled_model,
                        n_burnin = 5000,
                        n_iter = 5000,
                        n_thin = 20)
```

```
## Burnin (5000 iterations)
```

```
## Sampling (5000 iterations)
```

---
# Model outputs

- The output consists of 3 parts:
 - `parameters`: model parameters (Se, Sp, `\(\ldots\)` )
 - `proba_inf`: herd level predicted probabilities of infection
 - `Gelman_diag`: results of Gelman-Rubin convergence diagnostics performed on model parameters


```r
str(samples, max.level = 1)
```

---
# Model outputs

- Model outputs should be saved on the disk
 - You usually do not want to re-run several hours of analysis !

- We store the 3 components of the JAGS output
 - as 3 csv files
 - in a folder called model_output




```r
write.csv(samples$parameters, "model_output/param.csv", row.names = FALSE)
write.csv(samples$proba_inf, "model_output/proba_inf.csv", row.names = FALSE)
write.csv(samples$Gelman_diag, "model_output/Gelman_diag.csv", row.names = FALSE)
```

---
# Convergence diagnostics

- Gelman-Rubin diagnostics
 - computed using the `gelman.diag()` function from the `coda` package
 - should be close to 1


```r
Gelman_diag &lt;- read.csv("model_output/Gelman_diag.csv")

Gelman_diag
```

```
##   Point.est. Upper.C.I.
## 1   1.003527   1.014059
## 2   1.039411   1.116247
## 3   1.038395   1.104518
## 4   1.025164   1.060062
```

---
# Model parameters

- Samples from the posterior distributions of the different model parameters


```r
param &lt;- as_tibble(read.csv("model_output/param.csv"))

head(param)
```

```
## # A tibble: 6 x 7
##   .chain .iteration .draw    Se    Sp   tau1  tau2
##    &lt;int&gt;      &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;
## 1      1          1     1 0.946 0.862 0.0181 0.995
## 2      1          2     2 0.951 0.867 0.0153 0.989
## 3      1          3     3 0.950 0.893 0.0134 0.995
## 4      1          4     4 0.949 0.895 0.0161 0.992
## 5      1          5     5 0.949 0.914 0.0163 0.989
## 6      1          6     6 0.948 0.898 0.0220 0.982
```

---
# Model parameters

- Convergence can be evaluated using traceplots


```r
ggplot(param, aes(x = .iteration, y = Se, col = factor(.chain))) +
  geom_line()
```

![](using_STOCfree_package_files/figure-html/parameter traceplots-1.png)&lt;!-- --&gt;

---
# Model parameters

- Densities can be visualised


```r
ggplot(param, aes(x = Se, colour = "Posterior")) +
  stat_density(geom = "line") +
  geom_function(fun = dbeta, args = list(5000, 260), aes(colour = "Prior")) +
  scale_colour_discrete(name  ="")
```

![](using_STOCfree_package_files/figure-html/posterior parameter density-1.png)&lt;!-- --&gt;

---
# Model parameters

- Summaries for all model parameters:


```r
param_summary(x = param)
```

```
##   parameter   50 %  2.5 % 97.5 %
## 1        Se 0.9500 0.9441 0.9553
## 2        Sp 0.8904 0.8347 0.9416
## 3      tau1 0.0184 0.0095 0.0317
## 4      tau2 0.9821 0.9671 0.9926
```


---
# Predicted probabilities of infection

- Samples from the predicted probabilities of infection for the different herds


```r
pinf &lt;- as_tibble(read.csv("model_output/proba_inf.csv"))

head(pinf)
```

```
## # A tibble: 6 x 6
##   herd_id predicted_proba .chain .iteration .draw predicted_status
##     &lt;int&gt;           &lt;dbl&gt;  &lt;int&gt;      &lt;int&gt; &lt;int&gt;            &lt;int&gt;
## 1       1          0.0181      1          1     1                0
## 2       1          0.989       1          2     2                1
## 3       1          0.995       1          3     3                1
## 4       1          0.992       1          4     4                1
## 5       1          0.989       1          5     5                1
## 6       1          0.0220      1          6     6                0
```

---
# Predicted probabilities of status positive

- Density for the overall probability of status positive


```r
ggplot(pinf, aes(x = predicted_proba)) +
  geom_density()
```

![](using_STOCfree_package_files/figure-html/plotting overall predicted probabilities of infection-1.png)&lt;!-- --&gt;

---
# Predicted probabilities of status positive

- Density for every herd


```r
ggplot(pinf, aes(x = predicted_proba, col = factor(herd_id))) +
  geom_density() +
  theme(legend.position = "none")
```

![](using_STOCfree_package_files/figure-html/plotting predicted probabilities of infection for each herd individually-1.png)&lt;!-- --&gt;

---
# Predicted probabilities of status positive

- Density for specific herds
 - herd 29: negative test results only


```r
sfd$test_data %&gt;%
  filter(herd_id == 29)
```

```
##   status_id herd_id month_id status_type test_id test_res
## 1       925      29        1           1       1        0
## 2       932      29        8           2       1        0
## 3       937      29       13           2       1        0
## 4       944      29       20           2       1        0
## 5       949      29       25           2       1        0
## 6       956      29       32           2       1        0
## 7       957      29       33           4      NA       NA
```

---
# Predicted probabilities of status positive

- Density for specific herds
 - herd 29: negative test results only


```r
pinf %&gt;%
  filter(herd_id == 29) %&gt;%
  ggplot(., aes(x = predicted_proba, col = factor(herd_id))) +
  geom_density()
```

![](using_STOCfree_package_files/figure-html/plotting predicted probabilities of infection for herd 29-1.png)&lt;!-- --&gt;

---
# Predicted probabilities of status positive

- Density for specific herds
 - herd 30: positive test results only


```r
sfd$test_data %&gt;%
  filter(herd_id == 30)
```

```
##   status_id herd_id month_id status_type test_id test_res
## 1       958      30        1           1       1        1
## 2       965      30        8           2       1        1
## 3       970      30       13           2       1        1
## 4       977      30       20           2       1        1
## 5       982      30       25           2       1        1
## 6       989      30       32           2       1        1
## 7       990      30       33           4      NA       NA
```

---
# Predicted probabilities of status positive

- Density for specific herds
 - herd 30: positive test results only


```r
pinf %&gt;%
  filter(herd_id == 30) %&gt;%
  ggplot(., aes(x = predicted_proba, col = factor(herd_id))) +
  geom_density()
```

![](using_STOCfree_package_files/figure-html/plotting predicted probabilities of infection for herd 30-1.png)&lt;!-- --&gt;

---
# Predicted probabilities of status positive

- Density for specific herds
 - herd 68: negative and positive test results


```r
sfd$test_data %&gt;%
  filter(herd_id == 68)
```

```
##   status_id herd_id month_id status_type test_id test_res
## 1      2212      68        1           1       1        0
## 2      2219      68        8           2       1        0
## 3      2224      68       13           2       1        0
## 4      2231      68       20           2       1        1
## 5      2236      68       25           2       1        1
## 6      2243      68       32           2       1        0
## 7      2244      68       33           4      NA       NA
```

---
# Predicted probabilities of status positive

- Density for specific herds
 - herd 68: negative and positive test results


```r
pinf %&gt;%
  filter(herd_id == 68) %&gt;%
  ggplot(., aes(x = predicted_proba, col = factor(herd_id))) +
  geom_density()
```

![](using_STOCfree_package_files/figure-html/plotting predicted probabilities of infection for herd 68-1.png)&lt;!-- --&gt;

---
# Predicted probabilities of status positive

- Density for specific herds
 - herd 68: negative and positive test results

### Explaining bi-modality:
- herd tested negative on month 32
- latent status on month 32
 - on some iterations, latent status sampled as negative `\(\rightarrow\)` predicted probability of infection on month 33 is `\(\tau_1\)`
 - on some iterations, latent status sampled as positive `\(\rightarrow\)` predicted probability of infection on month 33 is `\(\tau_2\)`

---
# Predicted probabilities of status positive

- Density for specific herds
 - herd 83: latest test results is positive


```r
sfd$test_data %&gt;%
  filter(herd_id == 83)
```

```
##   status_id herd_id month_id status_type test_id test_res
## 1      2707      83        1           1       1        0
## 2      2714      83        8           2       1        0
## 3      2719      83       13           2       1        0
## 4      2726      83       20           2       1        0
## 5      2731      83       25           2       1        0
## 6      2738      83       32           2       1        1
## 7      2739      83       33           4      NA       NA
```

---
# Predicted probabilities of status positive

- Density for specific herds
 - herd 83: latest test results is positive


```r
pinf %&gt;%
  filter(herd_id == 83) %&gt;%
  ggplot(., aes(x = predicted_proba, col = factor(herd_id))) +
  geom_density()
```

![](using_STOCfree_package_files/figure-html/plotting predicted probabilities of infection for herd 83-1.png)&lt;!-- --&gt;

---
# Predicted probabilities of status positive

- Density for specific herds
 - herds 29, 30, 68 and 83


```r
pinf %&gt;%
  filter(herd_id %in% c(29, 30, 68, 83)) %&gt;%
  ggplot(., aes(x = predicted_proba, col = factor(herd_id))) +
  geom_density()
```

![](using_STOCfree_package_files/figure-html/plotting predicted probabilities of infection for 4 herds-1.png)&lt;!-- --&gt;

---
# Categorisation of herds into status negative / positive

- Need to get from a probability distribution to negative / positive for each herd

- Solution currently explored:
 - summarise each herd probability distribution with a quantile (e.g. median)
 - set a threshold below which herds are categorised as negative and above which they are positive
 - implemented in the `herd_summary()` function

---
# Categorisation of herds into status negative / positive

- test


```r
hrd_prob &lt;- herd_summary(pinf, sfd, quantile = 0.5, cut_off = 0.5)

head(hrd_prob)
```

```
##    Farm      proba predicted_status
## 1 FR001 0.02302466                0
## 2 FR002 0.14897624                0
## 3 FR003 0.01840883                0
## 4 FR004 0.98169493                1
## 5 FR005 0.98200725                1
## 6 FR006 0.98151774                1
```


---
class: inverse, center, middle

# Modelling herd level data
# Test results and risk factors

---
# Risk factors of new infection

- Risk factors could improve detection:

 - As an addition to test results
 - When recorded between tests

--

- Which risk factors to include?

 - known from the literature
 - associated to new infection in the data

--

- What delay between risk factors and new infection?
 - There could be some time between exposure to a risk factor and becoming infected

---
# Risk factors of new infection

- Not possible to evaluate all possible associations using the STOC free model
 - Bayesian inference is too time consuming!

--

.center[&lt;img src="./imgs/Bayesian_inference_Spongebob.png" style="width: 75%" /&gt;]

.footnote[[1] https://twitter.com/ChelseaParlett/status/1296490493539487745]


---
# Evaluation of risk factors of new infection using surveillance data

- Different functions implemented in the package to help evaluating putative associations

- These functions rely on the R `glm()` function
 - Logistic models
 

---
# Association number of cattle purchased - seroconversion

- Here, we will estimate associations between the number of animal purcahsed and seroconversion from the available data

--

- In the case of BVD
 - Possible delay between cattle purchase and the birth of persistently infected calves
 - What is the best time delay to use?

- This is investigated using the `intro` dataset included in the package

---
# The intro dataset

- Included in the `STOCfree` package

- Same herds as in the `herdBTM` dataset

- Number of cattle introduced per herd


```r
head(intro)
```

```
## # A tibble: 6 x 3
##   Farm  dateIntr   nAnim
##   &lt;chr&gt; &lt;fct&gt;      &lt;int&gt;
## 1 FR001 2010-01-22     1
## 2 FR001 2015-05-04    14
## 3 FR002 2011-02-11     2
## 4 FR002 2010-12-23     5
## 5 FR003 2012-11-07     3
## 6 FR003 2016-05-25     5
```

---
# The logit_nwinf_lagged() function

- Probability of becoming positive between consecutive tests modelled as a function of a risk factor using logistic regression

- Considers all sequences of 2 consecutive tests where the `\(1^{st}\)` test is negative

- Within a given range, all possible intervals between exposure to risk factor and outcome modelled

- AICs of the different models are reported for the identification of the best interval

---
# Association number of cattle purchased - seroconversion

- Natural logarithm of number of cattle used (better fit)


```r
intro$ln_nAnim &lt;- log(intro$nAnim + 1)

nAnim_lagged &lt;- logit_nwinf_lagged(
  sf_data = sfd,
  rf_data = intro,
  rf_date_col = "dateIntr",
  rf_col = "ln_nAnim",
  time_of_inf = "mid",
  lag1 = 0,
  lag2 = 24)

head(nAnim_lagged)
```

```
##   lag1 lag2 l      AIC
## 1    0    0 0 282.1230
## 2    0    1 1 283.0213
## 3    1    1 0 284.6300
## 4    0    2 2 283.5256
## 5    1    2 1 284.5612
## 6    2    2 0 284.5422
```


---
# Association number of cattle purchased - seroconversion

- Plot of the results: best interval = 8 to 8


```r
ggplot(data = nAnim_lagged, aes(x = lag2, y = lag1, fill = AIC)) +
  geom_tile() +
  xlab("Time Lag 2 (months)") + ylab("Time Lag 1 (months)") +
  scale_fill_gradient(low = "red", high = "yellow", aesthetics = "fill") +
  ggtitle("Number of animals purchased")
```

![](using_STOCfree_package_files/figure-html/plot of associations cattle introduced and seroconversion-1.png)&lt;!-- --&gt;

---
# Association local serporevalence - seroconversion

- Same idea as above
 - Maximum of the local prevalence over the considered interval


```r
lsprev &lt;- logit_nwinf_lagged(
  sf_data = sfd,
  rf_data = bvd,
  rf_date_col = "DateOfTest",
  rf_col = "LocalSeroPrev",
  time_of_inf = "mid",  lag1 = 0, lag2 = 24,
  FUN = max)
```

---
# Association local serporevalence - seroconversion

- Plot of the results

![](using_STOCfree_package_files/figure-html/plot association local seroprevalence seroconversion-1.png)&lt;!-- --&gt;

- Best interval: 5 to 5


---
# Multivariate logistic model

- Objective: evaluate associations between risk factors identified at the previous step and probability of becoming status positive

- Creation of the outcome dataset


```r
nwinf &lt;- make_nwinf_data(sfd,
                         time_of_inf = "mid")
```


---
# Multivariate logistic model

- Structure of the object


```r
str(nwinf)
```

```
## List of 2
##  $ herd_id_corresp:'data.frame':	100 obs. of  2 variables:
##   ..$ Farm   : chr [1:100] "FR001" "FR002" "FR003" "FR004" ...
##   ..$ herd_id: int [1:100] 1 2 3 4 5 6 7 8 9 10 ...
##  $ nwinf_data     :'data.frame':	251 obs. of  4 variables:
##   ..$ status_id: int [1:251] 41 46 53 58 66 74 79 86 91 98 ...
##   ..$ herd_id  : num [1:251] 2 2 2 2 2 3 3 3 3 3 ...
##   ..$ month_id : num [1:251] 4 10 16 22 29 4 10 16 22 28 ...
##   ..$ nwinf    : num [1:251] 0 0 0 0 1 0 0 0 0 0 ...
##  - attr(*, "month first test")= chr "2014-02"
##  - attr(*, "month last test")= chr "2016-10"
##  - attr(*, "time of inf")= chr "mid"
##  - attr(*, "class")= chr "nwinf_data"
```

---
# Multivariate logistic model

- Adding lagged risk factors


```r
nwinf &lt;- add_risk_factor(nwinf,
                         intro,
                         rf_col = "ln_nAnim",
                         rf_date_col = "dateIntr",
                         lag1 = 8,
                         lag2 = 8)

nwinf &lt;- add_risk_factor(nwinf,
                         bvd,
                         rf_col = "LocalSeroPrev",
                         rf_date_col = "DateOfTest",
                         lag1 = 5,
                         lag2 = 5)
```

---
# Multivariate logistic model

- Structure of the object


```r
str(nwinf)
```

```
## List of 2
##  $ herd_id_corresp:'data.frame':	100 obs. of  2 variables:
##   ..$ Farm   : chr [1:100] "FR001" "FR002" "FR003" "FR004" ...
##   ..$ herd_id: int [1:100] 1 2 3 4 5 6 7 8 9 10 ...
##  $ nwinf_data     :'data.frame':	251 obs. of  6 variables:
##   ..$ herd_id          : num [1:251] 10 10 10 10 10 100 100 100 100 100 ...
##   ..$ month_id         : num [1:251] 10 16 22 28 4 10 16 22 28 4 ...
##   ..$ nwinf            : num [1:251] 0 0 0 0 0 0 0 0 1 0 ...
##   ..$ status_id        : int [1:251] 310 317 322 329 305 3280 3286 3292 3299 3275 ...
##   ..$ ln_nAnim_8_8     : num [1:251] 0 0 0 0 0 0 0 0 0 0 ...
##   ..$ LocalSeroPrev_5_5: num [1:251] 0 0 0 0 0 0 0 0 0 0 ...
##  - attr(*, "month first test")= chr "2014-02"
##  - attr(*, "month last test")= chr "2016-10"
##  - attr(*, "time of inf")= chr "mid"
##  - attr(*, "class")= chr "nwinf_data"
```

---
# Multivariate logistic model

- Model


```r
modl &lt;- logit_nwinf(nwinf,
                    risk_factors = c("ln_nAnim_8_8", 
                                     "LocalSeroPrev_5_5"))
```

---
# Multivariate logistic model

- Model results


```r
summary(modl)
```

```
## 
## Call:
## glm(formula = formula, family = binomial(link = "logit"), data = data)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -1.3037  -0.7045  -0.7045  -0.7045   1.7408  
## 
## Coefficients:
##                     Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)          -1.2671     0.1598  -7.930 2.18e-15 ***
## ln_nAnim_8_8          0.4679     0.2508   1.866   0.0621 .  
## LocalSeroPrev_5_5   199.6583 11831.5751   0.017   0.9865    
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 280.63  on 250  degrees of freedom
## Residual deviance: 265.93  on 248  degrees of freedom
## AIC: 271.93
## 
## Number of Fisher Scoring iterations: 16
```

---
# Including risk factors in the STOCfree model

- ln(number animals purchased + 1) is added to the model

- This is done by updating the STOCfree_ data object


```r
sfd &lt;- sf_add_risk_factor(
  sfd = sfd,
  risk_factor_data = intro,
  risk_herd_col = "Farm",
  risk_date_col = "dateIntr",
  risk_factor_col = "ln_nAnim",
  risk_factor_type = "continuous",
  lag1 = 8,
  lag2 = 8,
  FUN = sum)
```

---
# Including risk factors in the STOCfree model

- Consequence:
  - `\(\tau_1\)` is not a model parameter anymore


```r
show_inf_dyn(sfd)
```

```
##  pi1_a  pi1_b tau2_a tau2_b 
##    1.0    1.0   10.0    1.5
```

---
# Including risk factors in the STOCfree model

- Consequences:
 - logistic regression for `\(\tau_{1t}\)`
 - need to specify prior distributions for the logistic regression
 

```r
show_rf(sfd)
```

```
##    risk_factor       type modality
## 1    Intercept  intercept       NA
## 2 ln_nAnim_8_8 continuous       NA
```

---
# Prior distributions for the logistic regression

- Logistic regression

`$$ln(\frac{\tau_{1t}}{1-\tau_{1t}}) = \theta_1 + \theta_2 x_t$$`

- Regression intercept 
 - log-odds of infection in the reference modality
 - here, when the number of purchased animals is 0
 
- Coefficients
 - increase in log-odds of new infection per unit of increase in the variable
 - here, increases per unit increase in ln(numeber animals + 1)

---
# Prior distributions for the logistic regression

- Logistic regression

`$$ln(\frac{\tau_{1t}}{1-\tau_{1t}}) = \theta_1 + \theta_2 x_t$$`

- Prior distributions

`$$\theta_1 \sim \mathcal{N}(\mu_1, \sigma^2_1)$$`

`$$\theta_2 \sim \mathcal{N}(\mu_2, \sigma^2_2)$$`

---
# Prior distributions for the logistic regression

- What are reasonable values for the `\(\theta\)`s?

![](using_STOCfree_package_files/figure-html/unnamed-chunk-16-1.png)&lt;!-- --&gt;

---
# Setting the prior distributions for the risk factors of new infection

- Intercept
 - mean set to -3 which corresponds to a probability of 0.047 for herds introducing no animal
 
- ln(number animals)+ 1
 - mean set to 0: assumes an absence of effect. 
 - Posterior driven by the data


```r
sfd &lt;- set_priors_rf(sfd,
                   risk_factor = "Intercept",
                   mean = -3, sd = 1)


sfd &lt;- set_priors_rf(sfd,
                   risk_factor = "ln_nAnim_8_8",
                   mean = 0, sd = 2)
```

---
# Setting the prior distributions for the risk factors of new infection

- The `STOCfree_data` object has been updated


```r
show_rf(sfd)
```

```
##    risk_factor       type modality mean_prior sd_prior
## 1    Intercept  intercept       NA         -3        1
## 2 ln_nAnim_8_8 continuous       NA          0        2
```

---
# Setting the prior distributions for the risk factors of new infection

- The `STOCfree_data` object has been updated


```r
sfd$risk_factor_data[c(1:10, 30:40),]
```

```
##    status_id herd_id month_id intercept ln_nAnim_8_8
## 1          1       1        1         1            0
## 2          2       1        2         1            0
## 3          3       1        3         1            0
## 4          4       1        4         1            0
## 5          5       1        5         1            0
## 6          6       1        6         1            0
## 7          7       1        7         1            0
## 8          8       1        8         1            0
## 9          9       1        9         1            0
## 10        10       1       10         1            0
## 30        30       1       30         1            0
## 31        31       1       31         1            0
## 32        32       1       32         1            0
## 33        33       1       33         1            0
## 34        34       2        1         1            0
## 35        35       2        2         1            0
## 36        36       2        3         1            0
## 37        37       2        4         1            0
## 38        38       2        5         1            0
## 39        39       2        6         1            0
## 40        40       2        7         1            0
```


---
# Setting the prior distributions for the risk factors of new infection

- The prior distributions can be plotted


```r
plot_priors_rf(sfd)
```

![](using_STOCfree_package_files/figure-html/plot prior distributions risk factors-1.png)&lt;!-- --&gt;

---
# Model compilation

- Same as previously


```r
compiled_model1 &lt;- compile_JAGS(sfd,
                               n_chains = 4,
                               keep_model_file = TRUE)
```

```
## Compiling model graph
##    Resolving undeclared variables
##    Allocating nodes
## Graph information:
##    Observed stochastic nodes: 580
##    Unobserved stochastic nodes: 3405
##    Total graph size: 32503
## 
## Initializing model
```

---
# Model sampling

- Same as previously


```r
samples &lt;- sample_model(compiled_model1,
                        n_burnin = 5000,
                        n_iter = 5000,
                        n_thin = 20)
```

```
## Burnin (5000 iterations)
```

```
## Sampling (5000 iterations)
```

---
# Model results saved

- Same as previously


```r
write.csv(samples$parameters, "model_output/rf_param.csv", row.names = FALSE)
write.csv(samples$proba_inf, "model_output/rf_proba_inf.csv", row.names = FALSE)
write.csv(samples$Gelman_diag, "model_output/rf_Gelman_diag.csv", row.names = FALSE)
```

---
# Model parameters


```r
param1 &lt;- as_tibble(read.csv("model_output/rf_param.csv"))

param_summary(x = param1)
```

```
##   parameter    50 %   2.5 %  97.5 %
## 1        Se  0.9498  0.9443  0.9561
## 2        Sp  0.8926  0.8315  0.9446
## 3      tau2  0.9824  0.9692  0.9926
## 4   theta.1 -4.0666 -4.7407 -3.4698
## 5   theta.2  0.3489 -3.1353  1.0728
```

---
# Predicted probabilities of infection


```r
pinf1 &lt;- as_tibble(read.csv("model_output/rf_proba_inf.csv"))

ggplot(pinf1, aes(x = predicted_proba)) +
  geom_density()
```

![](using_STOCfree_package_files/figure-html/unnamed-chunk-17-1.png)&lt;!-- --&gt;

---
class: inverse, center, middle

# Questions ?
# Remarks ?



---
background-image: url(./imgs/last_slide.png)
background-size: contain
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
